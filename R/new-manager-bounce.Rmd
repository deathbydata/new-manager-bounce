---
title: "New Manager Bounce"
author: "Josh Muncke"
date: "17/03/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Measuring the "New Manager Bounce" in the EPL

```{r load our packages, message=FALSE}
library(tidyverse)
library(rvest)
library(lubridate)
library(magrittr)
library(redbull)
library(feather)
```

## Extract data

### The managers

First we will pull the list of EPL managers, clubs and time-periods from the Wikipedia article on [Premier League Managers](https://en.wikipedia.org/wiki/List_of_Premier_League_managers).

We're going to use `extract2` from the `magrittr` library which is a nice pipe-able replacement for `[[`. The actually scraping is done by `rvest`.
```{r scrape manager data}
url <- "https://en.wikipedia.org/wiki/List_of_Premier_League_managers"

managers_raw <- url %>% 
  read_html() %>% 
  html_nodes("table") %>% 
  extract2(2) %>% 
  html_table(fill = T) %>% 
  as_tibble()
```

Now we can parse this tibble into something more friendly. We only need the manager name, club and date from and to.
```{r prepare manager data}
managers_prep <- managers_raw %>% dplyr::select(manager_name = Name, 
                                         managed_club = Club, 
                                         managed_from = From, 
                                         managed_until = Until)

managers_prep %<>% mutate(managed_until = if_else(managed_until == 'Present*', format.Date(Sys.Date() + 1, format = "%e %B %Y"), managed_until))

managers_prep %<>% mutate(managed_from = lubridate::as_date(managed_from, format = "%e %B %Y", tz = "UTC"), 
                          managed_until = lubridate::as_date(managed_until, format = "%e %B %Y", tz = "UTC"))
```

Need to fix a few little errors in this data..... ***
```{r manager cleanup}
managers_prep %<>%
  filter(! (manager_name == "Tomas Brolin" & managed_club == "Crystal Palace")) %>%
  filter(! (manager_name == "Ray Lewington" & managed_club == "Crystal Palace")) %>%
  filter(! (manager_name == "Mike Stowell" & managed_club == "Leicester City"))
```

```{r}
managers_prep %<>%
  arrange(managed_club, managed_from) %>%
  group_by(managed_club) %>%
  mutate(next_mgr_started = lead(managed_from)) %>% 
  mutate(overlap = as.numeric(next_mgr_started - managed_until)) %>%
  mutate(overlap = if_else(is.na(overlap), 1, overlap)) %>%
  mutate(managed_until = if_else(overlap == 0, managed_until - 1, managed_until)) %>%
  dplyr::select(-next_mgr_started, -overlap) %>%
  ungroup()
```

```{r}
managers_prep %>% write_feather(path = "../data/managers.feather")
```

### Club name mapping

In the two datasets clubs are named differently (e.g. "Man United" vs "Manchester United"). I considered doing a little string similarity comparison to fix this but ultimately I took the lazy/boring route and just created a separate lookup table.

```{r club name matching}
club_names <- tribble(
  ~short_name, ~long_name,
  "Man United", "Manchester United",
  "Huddersfield", "Huddersfield Town",
  "Newcastle", "Newcastle United",
  "Wolves", "Wolverhampton Wanderers",
  "Cardiff", "Cardiff City",
  "Leicester", "Leicester City",
  "Tottenham", "Tottenham Hotspur",
  "West Ham", "West Ham United",
  "Brighton", "Brighton & Hove Albion",
  "Man City", "Manchester City",
  "Bolton", "Bolton Wanderers",
  "Blackburn", "Blackburn Rovers",
  "Wigan", "Wigan Athletic",
  "QPR", "Queens Park Rangers",
  "Hull", "Hull City",
  "Swansea", "Swansea City",
  "Stoke", "Stoke City",
  "West Brom", "West Bromwich Albion",
  "Derby", "Derby County",
  "Charlton", "Charlton Athletic",
  "Leeds", "Leeds United",
  "Middlesboro", "Middlesbrough",
  "Ipswich", "Ipswich Town",
  "Coventry", "Coventry City",
  "Bradford", "Bradford City",
  "Sheffield Weds", "Sheffield Wednesday",
  "Nott'm Forest", "Nottingham Forest",
  "Norwich", "Norwich City",
  "Birmingham", "Birmingham City")

club_names %>% head() %>% knitr::kable()
```

```{r}
club_names %>% write_feather(path = "../data/club_name_mapping.feather")
```

### The games

We're going to scrape the game data from the excellent [football-data.co.uk](http://football-data.co.uk) site. The game-by-game data files are stored like this: `http://football-data.co.uk/mmz4281/1819/E0.csv` where the `1819` signifies the 2018-2019 season.

To get at this we'll create a vector of game files and then `purrr::map` the `read_csv` function over it. Sweet.

```{r extract game data, message=FALSE}
firstyear <- 1995
lastyear <- 2019

from_date <- seq(lastyear - 1, firstyear, -1) %>% as.character() %>% substr(3,4)
to_date <- seq(lastyear, firstyear + 1, -1) %>% as.character() %>% substr(3,4)
date_seq <- paste0(from_date, to_date)

game_data_filenames <- paste0("http://football-data.co.uk/mmz4281/", date_seq, "/E0.csv")

games_raw <- game_data_filenames %>% 
  map(function(x) read_csv(x) %>% select(Date:FTAG) %>% as.data.frame()) %>% 
  reduce(rbind) %>%
  as_tibble() %>%
  filter(complete.cases(.))
```

```{r}
games_raw %<>% mutate(Date = as.character(Date)) %>% as_tibble()

games_raw %>% write_feather("../data/game_data_raw.feather")
```

There's a bunch of `problems()` with this file because of column inconsistencies but the main thing we need for our analysis - dates, teams and results are read in okay. Let's shut our eyes on the other stuff and pretend we didn't see it.

Now that we have this raw data we need to fill it out. We have a table of matches but each match contains data for the home team and away team so it needs to be doubled out.

```{r}
games_raw <- read_feather("../data/game_data_raw.feather")
```

```{r map club names}
games_raw %<>% 
  left_join(club_names, by = c("HomeTeam" = "short_name")) %>%
  mutate(HomeTeam = ifelse(is.na(long_name), HomeTeam, long_name)) %>%
  select(-long_name) %>% 
  left_join(club_names, by = c("AwayTeam" = "short_name")) %>%
  mutate(AwayTeam = ifelse(is.na(long_name), AwayTeam, long_name)) %>%
  select(-long_name)
```

```{r prepare game data}
games_prep <- games_raw %>% 
  select(game_date = Date, everything()) %>% 
  mutate(game_id = row_number())

games_prep %<>% 
  mutate(game_date = case_when(
  str_length(game_date) == 10 ~ as_date(game_date, format = "%d/%m/%Y", tz = "UTC"),
  str_length(game_date) == 8 ~ as_date(game_date, format = "%d/%m/%y", tz = "UTC"),
  TRUE ~ as_date('1900-01-01', tz = "UTC")))

home_games <- games_prep %>% 
  select(game_id, game_date, game_team = HomeTeam, goals = FTHG, opponent = AwayTeam, opponent_goals = FTAG) %>%
  mutate(game_location = "Home", 
         points = case_when(goals > opponent_goals ~ 3, goals < opponent_goals ~ 0, TRUE ~ 1))

away_games <- games_prep %>% 
  select(game_id, game_date, game_team = AwayTeam, goals = FTAG, opponent = HomeTeam, opponent_goals = FTHG) %>%
  mutate(game_location = "Away", 
         points = case_when(goals > opponent_goals ~ 3, goals < opponent_goals ~ 0, TRUE ~ 1))

game_results_full <- 
  bind_rows(home_games, away_games)

game_results_full %>% write_feather("../data/game_results_full.feather")
```

```{r}
library(directlabels)

game_results_full %>%
  group_by(game_team) %>%
  arrange(game_date) %>%
  mutate(cumulative_points = cumsum(points)) %>%
  ggplot(aes(x = game_date, y = cumulative_points, group = game_team)) +
  geom_line() +
  geom_dl(aes(label = game_team), method = "last.points")

game_results_full %>%
  ggplot(aes(colour = game_location, x = points)) +
  geom_line(stat = "density")
```


# The fun bit

## Create a joined up df
```{r}
results <- read_feather("../data/game_results_full.feather")
managers <- read_feather("../data/managers.feather")
```


So now we can ask simple questions like...who had the longest managerial spells across clubs?

```{r longest serving mgrs}
theme_set(theme_rb())

managers_prep %>%
  mutate(managed_time = as.numeric(managed_until - managed_from)/365.25) %>%
  top_n(10, wt = managed_time) %>%
  mutate(manager_name = as.factor(paste(manager_name, managed_club, sep = "\n"))) %>%
  mutate(manager_name = fct_reorder(manager_name, managed_time)) %>%
  ggplot(aes(x = manager_name, y = managed_time)) +
  geom_col() +
  coord_flip()
```

# Putting it together

```{r}
game_results_full %>% 
  anti_join(managers_prep,  by = c("game_team" = "managed_club")) %>%
  select(game_team) %>%
  distinct()

managers_prep %>% 
  anti_join(game_results_full,  by = c("managed_club" = "game_team")) %>%
  select(managed_club) %>%
  distinct()
```


```{r}
full_result_data <- game_results_full %>%
  left_join(managers_prep, by = c("game_team" = "managed_club")) %>%
  mutate(valid_date = (game_date >= managed_from & game_date <= managed_until))

valid_games <- full_result_data %>% 
  filter(valid_date) %>%
  add_count(game_id) %>% 
  filter(n == 2) 

valid_games %>%
  ggplot(aes(y = goals, x = game_location)) +
  geom_boxplot()

valid_games %<>% 
  mutate(manager_tenure = as.numeric(game_date - managed_from))

valid_games %>% 
  mutate(mgr_tenure_group = cut(manager_tenure, c(0, 28, 45, 60, 90, 120, 180, 270, 365, 720, 99999))) %>%
  group_by(mgr_tenure_group, game_location, points) %>%
  tally() %>% 
  ungroup() %>%
  group_by(mgr_tenure_group, game_location) %>%
  mutate(n = n / sum(n)) %>%
  spread(points, n)

valid_games %>% 
  mutate(mgr_tenure_group = cut(manager_tenure, c(-1, 28, 45, 60, 90, 120, 180, 270, 365, 720, 99999))) %>%
  group_by(mgr_tenure_group, game_location) %>%
  summarise(average_points = mean(points)) %>%
  ggplot(aes(x = mgr_tenure_group, y = average_points)) +
  geom_col() +
  facet_wrap(~ game_location)

goals <- full_result_data %>% 
  filter(valid_date) %>%
  add_count(game_id) %>% filter(n == 2) %>%
  pull(goals)

x <- MASS::fitdistr(goals, densfun = "Poisson") %>% broom::tidy()

exp_goals <- rpois(18000, lambda = x %>% pull(estimate))

curve(dpois(c(0:10), x %>% pull(estimate)))

plot(exp_goals)

matchesFinal %>% 
  filter(Team == "Chelsea") %>% 
  group_by(Name) %>% 
  arrange(MatchDate) %>% 
  mutate(runningPoints = cummean(Points)) %>%
  mutate(daysInCharge = MatchDate - first(From)) %>%
  ggplot(aes(x = daysInCharge, y = runningPoints, colour = Name)) + 
  geom_point() +
  geom_smooth(se = F, method = "lm")
```




