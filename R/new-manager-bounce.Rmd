---
title: "New Manager Bounce"
author: "Josh Muncke"
date: "17/03/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Measuring the "New Manager Bounce" in the EPL

```{r load our packages, message=FALSE}
library(tidyverse)
library(rvest)
library(lubridate)
library(magrittr)
library(redbull)
```

## Extract data

### The managers

First we will pull the list of EPL managers, clubs and time-periods from the Wikipedia article on [Premier League Managers](https://en.wikipedia.org/wiki/List_of_Premier_League_managers).

We're going to use `extract2` from the `magrittr` library which is a nice pipe-able replacement for `[[`. The actually scraping is done by `rvest`.
```{r scrape manager data}
url <- "https://en.wikipedia.org/wiki/List_of_Premier_League_managers"

managers_raw <- url %>% 
  read_html() %>% 
  html_nodes("table") %>% 
  extract2(2) %>% 
  html_table(fill = T) %>% 
  as_tibble()
```

Now we can parse this tibble into something more friendly. We only need the manager name, club and date from and to.
```{r prepare manager data}
managers_prep <- managers_raw %>% select(manager_name = Name, 
                                         managed_club = Club, 
                                         managed_from = From, 
                                         managed_until = Until)

managers_prep %<>% mutate(managed_until = if_else(managed_until == 'Present*', format.Date(Sys.Date() + 1, format = "%e %B %Y"), managed_until))

managers_prep %<>% mutate(managed_from = lubridate::as_date(managed_from, format = "%e %B %Y", tz = "UTC"), 
                          managed_until = lubridate::as_date(managed_until, format = "%e %B %Y", tz = "UTC"))
```

So now we can ask simple questions like...who had the longest managerial spells across clubs?

```{r longest serving mgrs}
theme_set(theme_rb())

managers_prep %>%
  mutate(managed_time = as.numeric(managed_until - managed_from)/365.25) %>%
  top_n(10, wt = managed_time) %>%
  mutate(manager_name = as.factor(paste(manager_name, managed_club, sep = "\n"))) %>%
  mutate(manager_name = fct_reorder(manager_name, managed_time)) %>%
  ggplot(aes(x = manager_name, y = managed_time)) +
  geom_col() +
  coord_flip()
```

### The games

We're going to scrape the game data from the excellent [football-data.co.uk](http://football-data.co.uk) site. The game-by-game data files are stored like this: `http://football-data.co.uk/mmz4281/1819/E0.csv` where the `1819` signifies the 2018-2019 season.

To get at this we'll create a vector of game files and then `purrr::map` the `read_csv` function over it. Sweet.

```{r extract game data, message=FALSE}
from_date <- seq(1995,2016,1) %>% as.character() %>% substr(3,4)
to_date <- seq(1996,2017,1) %>% as.character() %>% substr(3,4)
date_seq <- paste0(from_date, to_date)

game_data_filenames <- paste0("http://football-data.co.uk/mmz4281/", date_seq, "/E0.csv")

games_raw <- game_data_filenames %>% 
  map(function(x) read_csv(x) %>% select(Date:FTAG) %>% as.data.frame()) %>% 
  reduce(rbind) %>%
  as_tibble()
```

There's a bunch of `problems()` with this file because of column inconsistencies but the main thing we need for our analysis - dates, teams and results are read in okay. Let's shut our eyes on the other stuff and pretend we didn't see it.

Now that we have this raw data we need to fill it out. We have a table of matches but each match contains data for the home team and away team so it needs to be doubled out.
```{r prepare game data}
games_prep <- games_raw %>% select(Game_Date = Date, everything())

home_games <- games_prep %>% select(Game_Date, Game_Club = HomeTeam, Goals = FTHG, Opponent = AwayTeam, Op_Goals = FTAG, Game_Location = )
x %<>% 
  mutate(HPoints = case_when(FTHG > FTAG ~ 3, FTHG < FTAG ~ 0, TRUE ~ 1)) %>%
  mutate(APoints = case_when(FTHG < FTAG ~ 3, FTHG > FTAG ~ 0, TRUE ~ 1))

hMatches <- x %>% select(Date, HomeTeam, HPoints, FTHG) %>% rename(Team = HomeTeam, Points = HPoints, Goals = FTHG) %>% mutate(Playing = "H")
aMatches <- x %>% select(Date, AwayTeam, APoints, FTAG) %>% rename(Team = AwayTeam, Points = APoints, Goals = FTAG) %>% mutate(Playing = "A")
matchesFinal <- hMatches %>% bind_rows(aMatches)
matchesFinal %<>% mutate(Date = as.Date(Date, format = "%d/%m/%y")) %>% rename(MatchDate = Date)
#matchesFinal %>% filter(Team == "Arsenal") %>% View()

matchesFinal %<>% left_join(managers, by = c("Team" = "Club")) %>% filter(MatchDate >= From, MatchDate <= Until)

matchesFinal %>% 
  filter(Team == "Chelsea") %>% 
  group_by(Name) %>% 
  arrange(MatchDate) %>% 
  mutate(runningPoints = cummean(Points)) %>%
  mutate(daysInCharge = MatchDate - first(From)) %>%
  ggplot(aes(x = daysInCharge, y = runningPoints, colour = Name)) + 
  geom_point() +
  geom_smooth(se = F, method = "lm")
```




