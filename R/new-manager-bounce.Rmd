---
title: "New Manager Bounce"
author: "Josh Muncke"
date: "17/03/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Measuring the "New Manager Bounce" in the EPL

```{r load our packages, message=FALSE}
library(tidyverse)
library(rvest)
library(lubridate)
library(magrittr)
library(redbull)
```

## Extract data

### The managers

First we will pull the list of EPL managers, clubs and time-periods from the Wikipedia article on [Premier League Managers](https://en.wikipedia.org/wiki/List_of_Premier_League_managers).

We're going to use `extract2` from the `magrittr` library which is a nice pipe-able replacement for `[[`. The actually scraping is done by `rvest`.
```{r scrape manager data}
url <- "https://en.wikipedia.org/wiki/List_of_Premier_League_managers"

managers_raw <- url %>% 
  read_html() %>% 
  html_nodes("table") %>% 
  extract2(2) %>% 
  html_table(fill = T) %>% 
  as_tibble()
```

Now we can parse this tibble into something more friendly. We only need the manager name, club and date from and to.
```{r prepare manager data}
managers_prep <- managers_raw %>% select(Manager_Name = Name, 
                                         Manager_Club = Club, 
                                         Managed_From = From, 
                                         Managed_Until = Until)

managers_prep %<>% mutate(Managed_Until = if_else(Managed_Until == 'Present*', format.Date(Sys.Date() + 1, format = "%e %B %Y"), Managed_Until))

managers_prep %<>% mutate(Managed_From = lubridate::as_date(Managed_From, format = "%e %B %Y", tz = "UTC"), 
                          Managed_Until = lubridate::as_date(Managed_Until, format = "%e %B %Y", tz = "UTC"))
```

So now we can ask simple questions like...who had the longest managerial spells across clubs?

```{r longest serving mgrs}
theme_set(theme_rb())

managers_prep %>%
  mutate(Managed_Time = as.numeric(Managed_Until - Managed_From)/365.25) %>%
  top_n(10, wt = Managed_Time) %>%
  mutate(Manager_Name = as.factor(paste(Manager_Name, Manager_Club, sep = "\n"))) %>%
  mutate(Manager_Name = fct_reorder(Manager_Name, Managed_Time)) %>%
  ggplot(aes(x = Manager_Name, y = Managed_Time)) +
  geom_col() +
  coord_flip()
```


```{r}
managers_prep %>% mutate(Duration_Calc = as.numeric(Managed_Until - Managed_From)) %>%
  mutate(duration_diff = Duration_Calc - Duration) %>%
  filter(duration_diff != 0)
```

```{r}
d1 <- seq(1995,2016,1) %>% as.character() %>% substr(3,4)
d2 <- seq(1996,2017,1) %>% as.character() %>% substr(3,4)
d3 <- paste0(d1,d2)

files <- paste0("http://football-data.co.uk/mmz4281/",d3,"/E0.csv")

x <- files %>% map(function(x) read_csv(x) %>% select(Date:FTAG) %>% as.data.frame()) %>% reduce(rbind)
x <- as_tibble(x)


x %<>% 
  mutate(HPoints = case_when(FTHG > FTAG ~ 3, FTHG < FTAG ~ 0, TRUE ~ 1)) %>%
  mutate(APoints = case_when(FTHG < FTAG ~ 3, FTHG > FTAG ~ 0, TRUE ~ 1))

hMatches <- x %>% select(Date, HomeTeam, HPoints, FTHG) %>% rename(Team = HomeTeam, Points = HPoints, Goals = FTHG) %>% mutate(Playing = "H")
aMatches <- x %>% select(Date, AwayTeam, APoints, FTAG) %>% rename(Team = AwayTeam, Points = APoints, Goals = FTAG) %>% mutate(Playing = "A")
matchesFinal <- hMatches %>% bind_rows(aMatches)
matchesFinal %<>% mutate(Date = as.Date(Date, format = "%d/%m/%y")) %>% rename(MatchDate = Date)
#matchesFinal %>% filter(Team == "Arsenal") %>% View()

matchesFinal %<>% left_join(managers, by = c("Team" = "Club")) %>% filter(MatchDate >= From, MatchDate <= Until)

matchesFinal %>% 
  filter(Team == "Chelsea") %>% 
  group_by(Name) %>% 
  arrange(MatchDate) %>% 
  mutate(runningPoints = cummean(Points)) %>%
  mutate(daysInCharge = MatchDate - first(From)) %>%
  ggplot(aes(x = daysInCharge, y = runningPoints, colour = Name)) + 
  geom_point() +
  geom_smooth(se = F, method = "lm")
```




